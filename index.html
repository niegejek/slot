<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <title>Psycho Slot - Full Integration</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        canvas { display: block; margin: 0 auto; }
    </style>
</head>
<body>
    <!-- PEÅNE I SPRAWDZONE LINKI DO BIBLIOTEK -->
    <script src="cdnjs.cloudflare.com"></script>
    <script src="cdnjs.cloudflare.com"></script>

    <script>
        let gameState = "IDLE";
        let hue = 0;

        (async () => {
            // 1. INICJALIZACJA (PixiJS v8)
            const app = new PIXI.Application();
            await app.init({ 
                width: 1280, 
                height: 720, 
                backgroundColor: 0x050510 
            });
            document.body.appendChild(app.canvas);

            // 2. FILTRY
            const blurFilter = new PIXI.BlurFilter();
            blurFilter.blur = 0;
            app.stage.filters = [blurFilter];

            // 3. WARSTWY I RAMKA
            const mainScene = new PIXI.Container();
            app.stage.addChild(mainScene);

            const frame = new PIXI.Graphics()
                .roundRect(240, 80, 800, 480, 40)
                .fill({ color: 0x000000, alpha: 0.8 })
                .stroke({ width: 8, color: 0xff00ff });
            mainScene.addChild(frame);

            // 4. AUDIO SYSTEM
            let audioCtx, analyser, dataArray;
            function initAudio() {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            }

            // 5. BONUS BUY - PORTALE
            const bonusUI = new PIXI.Container();
            app.stage.addChild(bonusUI);

            function openBonusBuy() {
                gameState = "BONUS_SELECT";
                gsap.to(mainScene, { alpha: 0.3, duration: 0.5 });
                const p1 = createPortal("ðŸŒ«ï¸ DREAMCORE", 440, 320, 0x00ffff, () => startBonus("DREAM"));
                const p2 = createPortal("ðŸ‘ï¸ DMT", 840, 320, 0xff0000, () => startBonus("DMT"));
                bonusUI.addChild(p1, p2);
            }

            function createPortal(txt, x, y, col, action) {
                const c = new PIXI.Container();
                const g = new PIXI.Graphics().circle(0, 0, 100).stroke({ width: 4, color: col });
                const t = new PIXI.Text({ text: txt, style: { fill: col, fontSize: 24 } });
                t.anchor.set(0.5);
                c.addChild(g, t);
                c.position.set(x, y);
                c.eventMode = 'static';
                c.cursor = 'pointer';
                c.on('pointerdown', action);
                return c;
            }

            function startBonus(type) {
                bonusUI.removeChildren();
                gsap.to(mainScene, { alpha: 1, duration: 1 });
                gameState = (type === "DMT") ? "BONUS_DMT" : "BONUS_DREAM";
            }

            // 6. PRZYCISK START (Inicjuje grÄ™ i audio)
            const spinBtn = new PIXI.Graphics().circle(0, 0, 50).fill(0x00ff66);
            spinBtn.position.set(1100, 600);
            spinBtn.eventMode = 'static';
            spinBtn.cursor = 'pointer';
            spinBtn.on('pointerdown', () => {
                if (!audioCtx) initAudio();
                if (gameState === "IDLE") openBonusBuy();
            });
            app.stage.addChild(spinBtn);

            // 7. GLOBAL TICKER
            app.ticker.add(() => {
                hue += 0.5;
                frame.tint = PIXI.Color.shared.setValue(`hsl(${hue % 360}, 100%, 60%)`).toNumber();

                if (analyser) {
                    analyser.getByteFrequencyData(dataArray);
                    let avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    spinBtn.scale.set(1 + avg / 200);
                }

                if (gameState === "BONUS_DMT") {
                    mainScene.x = Math.random() * 10 - 5;
                    mainScene.y = Math.random() * 10 - 5;
                }

                if (gameState === "BONUS_DREAM") {
                    blurFilter.blur = Math.sin(Date.now() * 0.002) * 5 + 5;
                }
            });
        })();
    </script>
</body>
</html>
